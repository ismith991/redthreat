<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Red Thread Games — Evidence Engine | Safe Combination</title>

  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&family=Courier+Prime:wght@400;700&family=Caveat:wght@400;700&display=swap" rel="stylesheet">

  <!-- Export Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      /* Global Noir */
      --bg:#0a0a0a;
      --panel:#1e1e1e;
      --card:#1c1c1c;
      --text:#e0e0e0;
      --muted:#b7b7b7;
      --line:#2a2a2a;
      --red:#d32f2f;

      /* Evidence Stage */
      --stage:#0b0b0b;
      --stageGlow: rgba(255,255,255,.04);

      /* Paper */
      --paper:#f3efe5;
      --paper2:#e9e1d2;
      --paperInk:#101010;
      --paperShadow: rgba(0,0,0,.55);
      --paperRot:-2deg;
      --paperScale:1;

      /* Burnt */
      --burn1: rgba(100,50,10,.55);
      --burn2: rgba(10,10,10,.70);
      --burnEdge: rgba(40,20,5,.95);

      /* Dial */
      --dialSize: 360px;
      --dialMetal1:#2b2b2b;
      --dialMetal2:#151515;
      --dialRing:#3a3a3a;
      --dialMark: rgba(255,255,255,.65);
      --dialMarkSoft: rgba(255,255,255,.18);
      --dialText: rgba(255,255,255,.82);
      --dialPointer: var(--red);

      --sans: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      --mono: "Courier Prime", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --hand: Caveat, "Shadows Into Light", cursive;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:var(--sans);
      overflow:hidden;
    }

    /* Split layout */
    .app{ display:flex; height:100vh; width:100vw; }

    /* Left: Control Center */
    .control{
      width:30%;
      min-width:340px;
      background:var(--panel);
      border-right:1px solid var(--line);
      padding:22px 18px;
      overflow:auto;
    }

    .cc-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .cc-title{
      margin:0;
      font-family:var(--mono);
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:13px;
      line-height:1.4;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .cc-title i{ color:var(--red); }

    .cc-badge{
      border:1px solid rgba(211,47,47,.65);
      color:var(--red);
      padding:6px 10px;
      border-radius:999px;
      font-size:10px;
      letter-spacing:.14em;
      text-transform:uppercase;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      margin-top:2px;
    }
    .cc-badge .dot{
      width:8px; height:8px; border-radius:50%;
      background:var(--red);
      box-shadow:0 0 12px rgba(211,47,47,.65);
    }

    .cc-card{
      background:rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      margin-bottom:12px;
      box-shadow:0 10px 20px rgba(0,0,0,.25);
    }

    .label{
      display:block;
      color:var(--muted);
      font-size:12px;
      margin-bottom:6px;
      letter-spacing:.02em;
    }
    .input, .select, .textarea{
      width:100%;
      border-radius:12px;
      border:1px solid #303030;
      background:#121212;
      color:var(--text);
      padding:11px 12px;
      outline:none;
      font-size:14px;
      font-family:var(--sans);
    }
    .input[type="number"]{ font-variant-numeric: tabular-nums; }
    .textarea{ min-height:88px; resize:vertical; font-family:var(--mono); }
    .input:focus, .select:focus, .textarea:focus{
      border-color:var(--red);
      box-shadow:0 0 0 3px rgba(211,47,47,.18);
    }
    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }
    .divider{ height:1px; background:var(--line); margin:12px 0; opacity:.9; }

    .btn{
      width:100%;
      border:none;
      border-radius:12px;
      background:linear-gradient(180deg, rgba(211,47,47,.92), rgba(211,47,47,.76));
      color:#fff;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      letter-spacing:.02em;
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn:active{ transform:translateY(1px); }

    .btnGhost{
      width:100%;
      border-radius:12px;
      border:1px solid #303030;
      background:#141414;
      color:var(--text);
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
    }
    .btnGhost:hover{ border-color:var(--red); }

    .tiny{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      margin:10px 0 0 0;
    }

    /* Right: Live Preview */
    .preview-wrap{
      width:70%;
      overflow:auto;
      padding:28px;
      background:#0b0b0b;
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }

    /* Evidence stage (not A4; this is a “photo scene”) */
    .stage{
      width: 980px;
      max-width: 100%;
      min-height: 760px;
      border-radius:18px;
      background:
        radial-gradient(1200px 700px at 20% 15%, rgba(255,255,255,.06), transparent 55%),
        radial-gradient(900px 600px at 80% 90%, rgba(211,47,47,.05), transparent 55%),
        linear-gradient(180deg, #080808, #0d0d0d);
      box-shadow:0 18px 48px rgba(0,0,0,.60);
      border:1px solid rgba(255,255,255,.06);
      position:relative;
      overflow:hidden;
      padding:26px;
    }
    /* subtle noise (pure CSS) */
    .stage:before{
      content:"";
      position:absolute;
      inset:-60px;
      background:
        repeating-linear-gradient(0deg, rgba(255,255,255,.015) 0 1px, transparent 1px 6px),
        repeating-linear-gradient(90deg, rgba(255,255,255,.010) 0 1px, transparent 1px 7px);
      opacity:.35;
      pointer-events:none;
      transform:rotate(2deg);
    }

    /* Top label */
    .stageHdr{
      position:relative;
      z-index:2;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:14px;
    }
    .stageHdr h1{
      margin:0;
      font-family:var(--mono);
      text-transform:uppercase;
      letter-spacing:.16em;
      font-size:14px;
      color:rgba(255,255,255,.90);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .stageHdr h1 i{ color:var(--red); }
    .stageHdr .sub{
      margin:8px 0 0 0;
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:rgba(255,255,255,.72);
    }
    .secure{
      border:1px solid rgba(211,47,47,.65);
      color:var(--red);
      border-radius:999px;
      padding:7px 10px;
      font-family:var(--mono);
      letter-spacing:.12em;
      text-transform:uppercase;
      font-size:10px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      background:rgba(211,47,47,.06);
    }
    .secure .dot{
      width:8px; height:8px; border-radius:50%;
      background:var(--red);
      box-shadow:0 0 14px rgba(211,47,47,.55);
    }

    /* Center layout inside stage */
    .scene{
      position:relative;
      z-index:2;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      gap:18px;
      padding:10px 0 6px;
    }

    /* Paper card */
    .paperWrap{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      width: 520px;
      max-width: 92%;
    }

    .paper{
      width:100%;
      background:
        radial-gradient(900px 220px at 20% 0%, rgba(255,255,255,.70), transparent 55%),
        linear-gradient(180deg, var(--paper), var(--paper2));
      color:var(--paperInk);
      border-radius:14px;
      box-shadow: 0 18px 40px var(--paperShadow);
      border:1px solid rgba(0,0,0,.08);
      padding:18px 18px 16px;
      transform: rotate(var(--paperRot)) scale(var(--paperScale));
      position:relative;
      overflow:hidden;
    }

    /* “Clean” texture (default) */
    .paper.clean:after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 320px at 80% 70%, rgba(0,0,0,.06), transparent 55%),
        repeating-linear-gradient(0deg, rgba(0,0,0,.018) 0 1px, transparent 1px 9px);
      opacity:.35;
      pointer-events:none;
    }

    /* Torn edge style */
    .paper.torn{
      clip-path: polygon(
        0% 0%,
        100% 0%,
        100% 86%,
        97% 88%,
        94% 86%,
        91% 90%,
        87% 86%,
        83% 92%,
        78% 86%,
        74% 91%,
        69% 86%,
        64% 92%,
        58% 87%,
        52% 93%,
        46% 87%,
        40% 92%,
        34% 87%,
        28% 92%,
        22% 86%,
        16% 90%,
        10% 86%,
        6% 90%,
        3% 87%,
        0% 86%
      );
    }
    .paper.torn:after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 320px at 70% 40%, rgba(0,0,0,.06), transparent 55%),
        repeating-linear-gradient(0deg, rgba(0,0,0,.018) 0 1px, transparent 1px 10px);
      opacity:.35;
      pointer-events:none;
    }
    .paper.torn:before{
      content:"";
      position:absolute;
      left:0; right:0; bottom:-2px;
      height:26px;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.12));
      opacity:.45;
      pointer-events:none;
    }

    /* Burnt style */
    .paper.burnt{
      background:
        radial-gradient(900px 260px at 10% 0%, rgba(255,255,255,.65), transparent 55%),
        radial-gradient(500px 220px at 85% 35%, rgba(0,0,0,.10), transparent 60%),
        linear-gradient(180deg, var(--paper), var(--paper2));
    }
    .paper.burnt:before{
      content:"";
      position:absolute;
      inset:-18px;
      background:
        radial-gradient(220px 160px at 10% 12%, rgba(0,0,0,.00) 30%, rgba(0,0,0,.55) 60%, rgba(0,0,0,.78) 78%, rgba(0,0,0,.0) 90%),
        radial-gradient(260px 170px at 92% 18%, rgba(0,0,0,.00) 34%, rgba(0,0,0,.52) 62%, rgba(0,0,0,.80) 80%, rgba(0,0,0,.0) 92%),
        radial-gradient(260px 190px at 90% 92%, rgba(0,0,0,.00) 34%, rgba(0,0,0,.50) 62%, rgba(0,0,0,.85) 82%, rgba(0,0,0,.0) 93%),
        radial-gradient(280px 190px at 8% 92%, rgba(0,0,0,.00) 34%, rgba(0,0,0,.46) 62%, rgba(0,0,0,.82) 82%, rgba(0,0,0,.0) 93%);
      filter: blur(1px);
      opacity:.42;
      pointer-events:none;
    }
    .paper.burnt:after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 360px at 50% 35%, rgba(120,70,20,.10), transparent 60%),
        repeating-linear-gradient(0deg, rgba(0,0,0,.018) 0 1px, transparent 1px 10px);
      opacity:.40;
      pointer-events:none;
    }

    .paperHdr{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      position:relative;
      z-index:2;
    }
    .paperHdr .tag{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: rgba(0,0,0,.68);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .paperHdr .tag i{ color: rgba(0,0,0,.62); }
    .paperHdr .case{
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color: rgba(0,0,0,.62);
      text-align:right;
      white-space:nowrap;
    }

    .code{
      margin:14px 0 6px;
      font-family:var(--hand);
      font-size:56px;
      font-weight:700;
      letter-spacing: .06em;
      text-align:center;
      color: rgba(10,10,10,.92);
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
      line-height:1;
      position:relative;
      z-index:2;
      user-select:text;
    }
    .codeSmall{
      margin-top:8px;
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      text-align:center;
      color: rgba(0,0,0,.58);
      position:relative;
      z-index:2;
    }

    /* Red arrow + directions */
    .directionRow{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      color:rgba(255,255,255,.86);
      font-family:var(--mono);
      letter-spacing:.14em;
      text-transform:uppercase;
      font-size:12px;
      margin-top:2px;
      user-select:none;
    }
    .dirPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border:1px solid rgba(211,47,47,.55);
      background: rgba(211,47,47,.10);
      padding:9px 12px;
      border-radius:999px;
      box-shadow:0 12px 22px rgba(0,0,0,.28);
    }
    .dirPill .arrow{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px; height:28px;
      border-radius:50%;
      border:1px solid rgba(211,47,47,.55);
      color:var(--red);
      background:rgba(0,0,0,.22);
    }
    .dirPill .seq{
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .seq b{ color:#fff; }
    .seq .sep{ opacity:.7; }

    /* Safe dial */
    .dialWrap{
      width: min(var(--dialSize), 92vw);
      height: min(var(--dialSize), 92vw);
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      margin-top:6px;
    }

    .dial{
      width:100%;
      height:100%;
      border-radius:50%;
      position:relative;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.12), transparent 45%),
        radial-gradient(circle at 70% 75%, rgba(0,0,0,.55), transparent 55%),
        linear-gradient(180deg, var(--dialMetal1), var(--dialMetal2));
      border:1px solid rgba(255,255,255,.08);
      box-shadow: 0 24px 55px rgba(0,0,0,.70);
      overflow:hidden;
    }

    /* Tick marks ring */
    .dial:before{
      content:"";
      position:absolute;
      inset:18px;
      border-radius:50%;
      background:
        conic-gradient(
          from -90deg,
          rgba(255,255,255,.0) 0deg 2deg,
          var(--dialMarkSoft) 2deg 3deg,
          rgba(255,255,255,.0) 3deg 9deg,
          var(--dialMarkSoft) 9deg 10deg
        );
      opacity:.85;
      mask: radial-gradient(circle, transparent 0 68%, #000 69% 100%);
      -webkit-mask: radial-gradient(circle, transparent 0 68%, #000 69% 100%);
      filter: drop-shadow(0 0 6px rgba(0,0,0,.55));
    }

    /* Inner ring */
    .ring{
      position:absolute;
      inset:56px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.10), transparent 55%),
        linear-gradient(180deg, #1a1a1a, #121212);
      box-shadow: inset 0 0 0 10px rgba(255,255,255,.03);
    }

    /* Center knob */
    .knob{
      position:absolute;
      inset:118px;
      border-radius:50%;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.20), rgba(255,255,255,.06) 35%, rgba(0,0,0,.75) 80%),
        linear-gradient(180deg, #262626, #151515);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:
        inset 0 10px 18px rgba(0,0,0,.45),
        0 18px 35px rgba(0,0,0,.45);
    }

    /* Dial numbers around edge */
    .dialNums{
      position:absolute;
      inset:0;
      pointer-events:none;
      font-family:var(--mono);
      font-size:12px;
      color:var(--dialText);
      letter-spacing:.06em;
      opacity:.92;
    }
    .dialNums span{
      position:absolute;
      left:50%;
      top:50%;
      transform-origin: 0 0;
      white-space:nowrap;
      text-shadow: 0 1px 0 rgba(0,0,0,.65);
    }

    /* Pointer */
    .pointer{
      position:absolute;
      top:10px;
      left:50%;
      transform:translateX(-50%);
      width:0; height:0;
      border-left:12px solid transparent;
      border-right:12px solid transparent;
      border-bottom:22px solid var(--dialPointer);
      filter: drop-shadow(0 8px 10px rgba(0,0,0,.55));
    }
    .pointer:after{
      content:"";
      position:absolute;
      left:-2px; top:18px;
      width:4px; height:16px;
      background:rgba(211,47,47,.65);
      border-radius:3px;
    }

    /* Readout under dial */
    .dialReadout{
      margin-top:6px;
      font-family:var(--mono);
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(255,255,255,.75);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .readBadge{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      padding:7px 10px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .readBadge i{ color:var(--red); }

    /* Responsive */
    @media (max-width: 1050px){
      body{ overflow:auto; }
      .app{ flex-direction:column; height:auto; }
      .control, .preview-wrap{ width:100%; }
      .preview-wrap{ padding:16px; justify-content:flex-start; }
      .stage{ width:100%; min-height:unset; }
      :root{ --dialSize: 320px; }
      .code{ font-size:48px; }
    }

    .control::-webkit-scrollbar, .preview-wrap::-webkit-scrollbar { width:10px; }
    .control::-webkit-scrollbar-thumb, .preview-wrap::-webkit-scrollbar-thumb{
      background:#2a2a2a;
      border-radius:10px;
      border:2px solid transparent;
      background-clip:content-box;
    }
    .control::-webkit-scrollbar-thumb:hover, .preview-wrap::-webkit-scrollbar-thumb:hover{
      background:#3a3a3a;
      background-clip:content-box;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- LEFT PANEL -->
    <aside class="control">
      <div class="cc-top">
        <h2 class="cc-title"><i class="fa-solid fa-vault"></i> Safe Combination</h2>
        <div class="cc-badge"><span class="dot"></span> SECURE CONNECTION</div>
      </div>

      <div class="cc-card">
        <label class="label" for="sheetTitle">Label (Optional)</label>
        <input id="sheetTitle" class="input" type="text" value="RECOVERED NOTE — SAFE COMBINATION" />

        <div style="height:10px"></div>
        <div class="row">
          <div>
            <label class="label" for="caseId">Case / Ref</label>
            <input id="caseId" class="input" type="text" value="RT-LG-008" />
          </div>
          <div>
            <label class="label" for="paperStyle">Paper Texture</label>
            <select id="paperStyle" class="select">
              <option value="clean" selected>Clean</option>
              <option value="torn">Torn</option>
              <option value="burnt">Burnt</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <label class="label">3-Number Combination</label>
        <div class="row">
          <input id="n1" class="input" type="number" min="0" max="99" value="40" />
          <input id="n2" class="input" type="number" min="0" max="99" value="22" />
          <input id="n3" class="input" type="number" min="0" max="99" value="96" />
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <button id="randomBtn" class="btnGhost">
            <i class="fa-solid fa-dice" style="margin-right:8px;"></i> Randomize
          </button>
          <button id="demoBtn" class="btnGhost">
            <i class="fa-solid fa-wand-magic-sparkles" style="margin-right:8px;"></i> Demo
          </button>
        </div>

        <div class="divider"></div>

        <label class="label" for="directionMode">Direction Pattern</label>
        <select id="directionMode" class="select">
          <option value="LRL" selected>Left — Right — Left</option>
          <option value="RLR">Right — Left — Right</option>
          <option value="custom">Custom Text</option>
        </select>

        <div style="height:10px"></div>

        <label class="label" for="customDir">Custom Direction Text (if Custom)</label>
        <input id="customDir" class="input" type="text" value="LEFT - RIGHT - LEFT" />

        <div class="divider"></div>

        <div class="row">
          <div>
            <label class="label" for="paperRotate">Paper Rotation</label>
            <input id="paperRotate" class="input" type="number" step="0.5" value="-2" />
          </div>
          <div>
            <label class="label" for="dialSize">Dial Size</label>
            <select id="dialSize" class="select">
              <option value="320">Small</option>
              <option value="360" selected>Medium</option>
              <option value="420">Large</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div>
            <label class="label" for="pointerColor">Pointer Color</label>
            <input id="pointerColor" class="input" type="color" value="#d32f2f" />
          </div>
          <div>
            <label class="label" for="showNumbers">Dial Numbers</label>
            <select id="showNumbers" class="select">
              <option value="on" selected>Show</option>
              <option value="off">Hide</option>
            </select>
          </div>
        </div>

        <p class="tiny">Built to be story-flexible: random code, texture options, direction pattern, dial size, and export.</p>
      </div>

      <div class="cc-card">
        <div class="row">
          <button id="exportJson" class="btnGhost">
            <i class="fa-solid fa-floppy-disk" style="margin-right:8px;"></i> Export JSON
          </button>
          <button id="importJson" class="btnGhost">
            <i class="fa-solid fa-file-import" style="margin-right:8px;"></i> Import JSON
          </button>
        </div>
      </div>

      <div class="cc-card">
        <div class="row">
          <div>
            <label class="label" for="exportType">Export Type</label>
            <select id="exportType" class="select">
              <option value="jpg" selected>High-res JPG</option>
              <option value="pdf">PDF</option>
            </select>
          </div>
          <div>
            <label class="label" for="exportScale">Quality</label>
            <select id="exportScale" class="select">
              <option value="2">Standard</option>
              <option value="3" selected>High</option>
              <option value="4">Ultra</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>

        <button id="downloadBtn" class="btn">
          <i class="fa-solid fa-download" style="margin-right:8px"></i>
          Download Evidence
        </button>
      </div>
    </aside>

    <!-- RIGHT PANEL -->
    <main class="preview-wrap">
      <section class="stage" id="captureArea" aria-label="Safe combination evidence preview">
        <div class="stageHdr">
          <div>
            <h1><i class="fa-solid fa-circle-nodes"></i> <span id="titleOut">RECOVERED NOTE — SAFE COMBINATION</span></h1>
            <div class="sub" id="subOut">RED THREAD // LOGIC FILE</div>
          </div>
          <div class="secure"><span class="dot"></span> SECURE CONNECTION</div>
        </div>

        <div class="scene">
          <div class="paperWrap">
            <div class="paper clean" id="paper">
              <div class="paperHdr">
                <div class="tag"><i class="fa-solid fa-paperclip"></i> HANDWRITTEN</div>
                <div class="case" id="caseOut">REF: RT-LG-008</div>
              </div>

              <div class="code" id="codeOut">40 - 22 - 96</div>
              <div class="codeSmall" id="codeHintOut">DO NOT SAY THIS OUT LOUD.</div>
            </div>
          </div>

          <div class="directionRow" id="dirRow">
            <div class="dirPill">
              <span class="arrow" id="dirA1"><i class="fa-solid fa-arrow-left"></i></span>
              <span class="seq" id="dirText"><b>LEFT</b><span class="sep">—</span><b>RIGHT</b><span class="sep">—</span><b>LEFT</b></span>
              <span class="arrow" id="dirA2"><i class="fa-solid fa-arrow-right"></i></span>
            </div>
          </div>

          <div class="dialWrap" id="dialWrap">
            <div class="dial" id="dial">
              <div class="pointer" id="pointer"></div>
              <div class="dialNums" id="dialNums" aria-hidden="true"></div>
              <div class="ring"></div>
              <div class="knob"></div>
            </div>
          </div>

          <div class="dialReadout">
            <span class="readBadge"><i class="fa-solid fa-key"></i> COMBO: <span id="readCombo">40-22-96</span></span>
            <span class="readBadge"><i class="fa-solid fa-rotate"></i> PATTERN: <span id="readPattern">L-R-L</span></span>
          </div>
        </div>
      </section>
    </main>

  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const pad2 = (n) => String(n).padStart(2,"0");
    const safeNum = (v) => {
      const n = Number(v);
      if(Number.isNaN(n)) return 0;
      return clamp(Math.round(n), 0, 99);
    };

    // Inputs
    const sheetTitle = $("sheetTitle");
    const caseId = $("caseId");
    const paperStyle = $("paperStyle");

    const n1 = $("n1"), n2 = $("n2"), n3 = $("n3");
    const randomBtn = $("randomBtn");
    const demoBtn = $("demoBtn");

    const directionMode = $("directionMode");
    const customDir = $("customDir");

    const paperRotate = $("paperRotate");
    const dialSize = $("dialSize");
    const pointerColor = $("pointerColor");
    const showNumbers = $("showNumbers");

    const exportJson = $("exportJson");
    const importJson = $("importJson");

    // Outputs
    const titleOut = $("titleOut");
    const caseOut = $("caseOut");
    const codeOut = $("codeOut");
    const readCombo = $("readCombo");

    const paper = $("paper");
    const dialWrap = $("dialWrap");
    const pointer = $("pointer");
    const dialNums = $("dialNums");

    const dirText = $("dirText");
    const readPattern = $("readPattern");

    // Export
    const downloadBtn = $("downloadBtn");
    const exportType = $("exportType");
    const exportScale = $("exportScale");
    const captureArea = $("captureArea");

    function buildDialNumbers(){
      dialNums.innerHTML = "";
      const size = dialWrap.getBoundingClientRect().width || 360;
      const radius = (size / 2) - 18; // near edge
      const cx = size/2, cy = size/2;

      // show 0..90 by 10
      for(let v=0; v<=90; v+=10){
        const ang = (-90 + (v/100)*360) * (Math.PI/180); // map 0 at top
        const x = cx + Math.cos(ang) * (radius - 16);
        const y = cy + Math.sin(ang) * (radius - 16);

        const s = document.createElement("span");
        s.textContent = String(v);
        // rotate a touch so it “follows” the dial (but stays readable)
        const rot = (-90 + (v/100)*360);
        s.style.left = x + "px";
        s.style.top  = y + "px";
        s.style.transform = `translate(-50%, -50%) rotate(${rot}deg)`;
        dialNums.appendChild(s);
      }
    }

    function getPattern(){
      const mode = directionMode.value;
      if(mode === "LRL") return { label:"L-R-L", text:"LEFT - RIGHT - LEFT", icons:["left","right"] };
      if(mode === "RLR") return { label:"R-L-R", text:"RIGHT - LEFT - RIGHT", icons:["right","left"] };
      return { label:"CUSTOM", text:(customDir.value || "LEFT - RIGHT - LEFT"), icons:["left","right"] };
    }

    function updateDirectionUI(){
      const p = getPattern();
      readPattern.textContent = p.label;

      // Build stylized direction text
      const parts = p.text.split(/[-–—]/).map(x => x.trim()).filter(Boolean);
      // fallback
      const a = parts[0] || "LEFT";
      const b = parts[1] || "RIGHT";
      const c = parts[2] || "LEFT";
      dirText.innerHTML = `<b>${a}</b><span class="sep">—</span><b>${b}</b><span class="sep">—</span><b>${c}</b>`;
    }

    function updateAll(){
      // Title + case
      titleOut.textContent = (sheetTitle.value || "RECOVERED NOTE — SAFE COMBINATION").trim();
      caseOut.textContent = `REF: ${(caseId.value || "—").trim()}`;

      // Paper style
      paper.classList.remove("clean","torn","burnt");
      paper.classList.add(paperStyle.value || "clean");

      // Paper rotation
      const rot = Number(paperRotate.value || -2);
      document.documentElement.style.setProperty("--paperRot", `${rot}deg`);

      // Dial size
      const ds = Number(dialSize.value || 360);
      document.documentElement.style.setProperty("--dialSize", `${ds}px`);

      // Pointer color
      document.documentElement.style.setProperty("--dialPointer", pointerColor.value || "#d32f2f");

      // Numbers
      dialNums.style.display = (showNumbers.value === "off") ? "none" : "block";

      // Code
      const a = safeNum(n1.value);
      const b = safeNum(n2.value);
      const c = safeNum(n3.value);
      const comboPretty = `${pad2(a)} - ${pad2(b)} - ${pad2(c)}`;
      const comboCompact = `${pad2(a)}-${pad2(b)}-${pad2(c)}`;
      codeOut.textContent = comboPretty;
      readCombo.textContent = comboCompact;

      // Direction
      updateDirectionUI();

      // Rebuild dial numbers after sizing changes
      requestAnimationFrame(buildDialNumbers);
    }

    function randomize(){
      n1.value = String(Math.floor(Math.random()*100));
      n2.value = String(Math.floor(Math.random()*100));
      n3.value = String(Math.floor(Math.random()*100));

      const styles = ["clean","torn","burnt"];
      paperStyle.value = styles[Math.floor(Math.random()*styles.length)];

      const patterns = ["LRL","RLR"];
      directionMode.value = patterns[Math.floor(Math.random()*patterns.length)];

      updateAll();
    }

    randomBtn.addEventListener("click", randomize);

    demoBtn.addEventListener("click", ()=>{
      sheetTitle.value = "RECOVERED NOTE — SAFE COMBINATION";
      caseId.value = "RT-LG-008";
      paperStyle.value = "torn";

      n1.value = "40";
      n2.value = "22";
      n3.value = "96";

      directionMode.value = "LRL";
      customDir.value = "LEFT - RIGHT - LEFT";

      paperRotate.value = "-2";
      dialSize.value = "360";
      pointerColor.value = "#d32f2f";
      showNumbers.value = "on";

      updateAll();
    });

    // JSON export/import (for reuse across stories)
    function getState(){
      return {
        title: sheetTitle.value,
        caseRef: caseId.value,
        paperStyle: paperStyle.value,
        combo: [safeNum(n1.value), safeNum(n2.value), safeNum(n3.value)],
        directionMode: directionMode.value,
        customDirection: customDir.value,
        paperRotate: Number(paperRotate.value || -2),
        dialSize: Number(dialSize.value || 360),
        pointerColor: pointerColor.value,
        showNumbers: showNumbers.value
      };
    }

    function setState(s){
      if(!s || typeof s !== "object") return;

      sheetTitle.value = s.title ?? sheetTitle.value;
      caseId.value = s.caseRef ?? caseId.value;
      paperStyle.value = s.paperStyle ?? paperStyle.value;

      if(Array.isArray(s.combo)){
        n1.value = String(s.combo[0] ?? n1.value);
        n2.value = String(s.combo[1] ?? n2.value);
        n3.value = String(s.combo[2] ?? n3.value);
      }

      directionMode.value = s.directionMode ?? directionMode.value;
      customDir.value = s.customDirection ?? customDir.value;

      paperRotate.value = String(s.paperRotate ?? paperRotate.value);
      dialSize.value = String(s.dialSize ?? dialSize.value);
      pointerColor.value = s.pointerColor ?? pointerColor.value;
      showNumbers.value = s.showNumbers ?? showNumbers.value;

      updateAll();
    }

    exportJson.addEventListener("click", async ()=>{
      const json = JSON.stringify(getState(), null, 2);
      try{
        await navigator.clipboard.writeText(json);
        alert("Copied JSON to clipboard.");
      }catch(e){
        prompt("Copy JSON:", json);
      }
    });

    importJson.addEventListener("click", ()=>{
      const raw = prompt("Paste saved JSON here:");
      if(!raw) return;
      try{
        setState(JSON.parse(raw));
      }catch(e){
        alert("Invalid JSON.");
      }
    });

    // Export evidence (Right Panel)
    function fileStamp(){
      const d = new Date();
      const pad = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }

    async function exportEvidence(){
      updateAll();
      const type = exportType.value;
      const scale = Number(exportScale.value || 3);

      const canvas = await html2canvas(captureArea, {
        backgroundColor: "#0b0b0b",
        scale,
        useCORS: true
      });

      const base = `safe_combination_${fileStamp()}`;

      if(type === "jpg"){
        const url = canvas.toDataURL("image/jpeg", 0.95);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${base}.jpg`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        return;
      }

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation:"l", unit:"pt", format:"a4" });

      const imgData = canvas.toDataURL("image/jpeg", 0.95);
      const pageW = pdf.internal.pageSize.getWidth();
      const pageH = pdf.internal.pageSize.getHeight();
      const margin = 22;

      const imgW = canvas.width;
      const imgH = canvas.height;

      const maxW = pageW - margin * 2;
      const maxH = pageH - margin * 2;

      const ratio = Math.min(maxW / imgW, maxH / imgH);
      const drawW = imgW * ratio;
      const drawH = imgH * ratio;

      const x = (pageW - drawW) / 2;
      const y = (pageH - drawH) / 2;

      pdf.addImage(imgData, "JPEG", x, y, drawW, drawH);
      pdf.save(`${base}.pdf`);
    }

    downloadBtn.addEventListener("click", exportEvidence);

    // Bind inputs
    [
      sheetTitle, caseId, paperStyle,
      n1, n2, n3,
      directionMode, customDir,
      paperRotate, dialSize,
      pointerColor, showNumbers
    ].forEach(el=>{
      el.addEventListener("input", updateAll);
      el.addEventListener("change", updateAll);
    });

    // Init
    updateAll();
    window.addEventListener("resize", ()=>requestAnimationFrame(buildDialNumbers));
  </script>
</body>
</html>
